name: '10: Dev Deployment'

# Deploys to dev environment when main branch is updated
# Dev environment: zenphry-cf-worker-dev.*.workers.dev (primary: dev.zenphry.com)
# Use for SEO testing, validating features before production
# See docs/CICD.md for complete documentation

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'
      - '.vscode/**'
      - '.idea/**'
      - '.editorconfig'
      - '.github/workflows/70-e2e-weekly.yml'
      - '.github/workflows/80-seo-audit.yml'
      - '.github/workflows/90-cleanup.yml'
  workflow_dispatch: # Allows manual triggering from GitHub UI

jobs:
  # Run quality checks first
  quality-checks:
    name: Quality Checks
    uses: ./.github/workflows/00-ci.yml
    secrets: inherit

  deploy:
    name: Deploy to dev
    needs: [quality-checks]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write  # Required to create commit comments

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js environment
        uses: ./.github/actions/setup-node

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-dist-${{ github.sha }}

      - name: Extract build artifact
        run: |
          tar -xzf build-dist.tar.gz
          rm build-dist.tar.gz
          echo "[OK] Build artifacts extracted"
          ls -la build/

      - name: Deploy to dev
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: "./build/server"
          command: deploy --env dev

      - name: Deployment summary
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ Deployed to dev environment"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "[INFO] URL: https://dev.zenphry.com"
          echo "[INFO] Health checks skipped (Cloudflare firewall blocks GitHub IPs)"
          echo "[INFO] Manually verify deployment if needed"
          echo ""
          echo "[INFO] To check deployment status:"
          echo "       npx wrangler deployments list --env dev"
          echo ""
          echo "[INFO] To rollback if needed:"
          echo "       npx wrangler rollback --env dev"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

      - name: Comment deployment URL
        uses: actions/github-script@v7
        if: github.event_name == 'push'
        with:
          script: |
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `✅ Deployed to dev: https://dev.zenphry.com\n\n**Note:** Health checks skipped (Cloudflare firewall). Manually verify if needed.\n\nCheck deployment: \`npx wrangler deployments list --env dev\``
            })
