name: '90: Cleanup'

on:
  schedule:
    # Run weekly on Sunday at 3am UTC
    - cron: '0 3 * * 0'
  workflow_dispatch: # Allow manual trigger

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: write # Required to delete releases

    steps:
      - name: Cleanup old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;

            // Get all artifacts
            const artifacts = await github.paginate(
              github.rest.actions.listArtifactsForRepo,
              {
                owner: repo.owner,
                repo: repo.repo,
                per_page: 100
              }
            );

            // Delete artifacts older than 7 days
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 7);

            let deletedCount = 0;
            for (const artifact of artifacts) {
              const createdAt = new Date(artifact.created_at);
              if (createdAt < cutoffDate) {
                await github.rest.actions.deleteArtifact({
                  owner: repo.owner,
                  repo: repo.repo,
                  artifact_id: artifact.id
                });
                console.log(`Deleted artifact: ${artifact.name} (${artifact.id})`);
                deletedCount++;
              }
            }

            console.log(`Deleted ${deletedCount} artifacts older than 7 days`);

      - name: Cleanup old caches
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;

            // Get all caches
            const caches = await github.paginate(
              github.rest.actions.getActionsCacheList,
              {
                owner: repo.owner,
                repo: repo.repo,
                per_page: 100
              }
            );

            // Delete caches older than 1 day
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 1);

            let deletedCount = 0;
            for (const cache of caches) {
              const lastAccessedAt = new Date(cache.last_accessed_at);
              if (lastAccessedAt < cutoffDate) {
                await github.rest.actions.deleteActionsCacheById({
                  owner: repo.owner,
                  repo: repo.repo,
                  cache_id: cache.id
                });
                console.log(`Deleted cache: ${cache.key} (${cache.id})`);
                deletedCount++;
              }
            }

            console.log(`Deleted ${deletedCount} caches older than 1 day`);

      - name: Cleanup old build releases
        uses: actions/github-script@v7
        with:
          script: |
            const repo = context.repo;

            // Get all releases
            const releases = await github.paginate(
              github.rest.repos.listReleases,
              {
                owner: repo.owner,
                repo: repo.repo,
                per_page: 100
              }
            );

            // Delete pre-releases (build artifacts) older than 7 days
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 7);

            let deletedCount = 0;
            for (const release of releases) {
              // Only delete pre-releases that are build or E2E artifacts
              const isAutomatedRelease = release.prerelease &&
                (release.tag_name.startsWith('build-') || release.tag_name.startsWith('e2e-'));

              if (isAutomatedRelease) {
                const createdAt = new Date(release.created_at);
                if (createdAt < cutoffDate) {
                  // Delete the release
                  await github.rest.repos.deleteRelease({
                    owner: repo.owner,
                    repo: repo.repo,
                    release_id: release.id
                  });

                  // Delete the associated tag
                  try {
                    await github.rest.git.deleteRef({
                      owner: repo.owner,
                      repo: repo.repo,
                      ref: `tags/${release.tag_name}`
                    });
                  } catch (e) {
                    // Tag may already be deleted
                  }

                  console.log(`Deleted release: ${release.tag_name} (${release.id})`);
                  deletedCount++;
                }
              }
            }

            console.log(`Deleted ${deletedCount} automated releases (build/e2e) older than 7 days`);
