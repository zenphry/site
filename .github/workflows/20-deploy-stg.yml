name: '20: Stg Deployment'

# MANUAL deployment to stg for pre-production validation
# stg: stg.zenphry.com
# Purpose: Test release candidate with same artifact that will go to prod
# To deploy: Go to Actions → Deploy to Staging (stg) → Run workflow → Select release branch
# See docs/CICD.md for complete documentation

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Release branch to deploy (e.g., release/2025-01-20-1430)'
        required: true
        type: string

jobs:
  # Validate inputs and get release branch SHA (fail fast)
  get-release-sha:
    name: Validate & Get SHA
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.get-sha.outputs.sha }}
    steps:
      # Fail fast: validate branch match before any checkout
      - name: Validate workflow branch matches input branch
        run: |
          WORKFLOW_REF="${{ github.ref }}"
          INPUT_BRANCH="${{ github.event.inputs.branch }}"

          # Extract branch name from refs/heads/...
          WORKFLOW_BRANCH="${WORKFLOW_REF#refs/heads/}"

          echo "[CHECK] Workflow 'Use workflow from': $WORKFLOW_BRANCH"
          echo "[CHECK] Input branch parameter: $INPUT_BRANCH"

          if [ "$WORKFLOW_BRANCH" != "$INPUT_BRANCH" ]; then
            echo ""
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "[ERROR] BRANCH MISMATCH - Deployment blocked"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            echo "The 'Use workflow from' dropdown must match the branch input."
            echo ""
            echo "To fix:"
            echo "  1. Click 'Run workflow' dropdown"
            echo "  2. Change 'Use workflow from' to: $INPUT_BRANCH"
            echo "  3. Enter the same branch in the input field"
            echo "  4. Click 'Run workflow'"
            echo ""
            exit 1
          fi

          echo "[OK] Branch match verified: $WORKFLOW_BRANCH"

      - name: Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Get release branch SHA
        id: get-sha
        run: |
          SHA=$(git rev-parse HEAD)
          echo "sha=$SHA" >> $GITHUB_OUTPUT
          echo "[ARTIFACT] Release branch SHA: $SHA"

  # Run quality checks with release branch context
  quality-checks:
    name: Quality Checks
    needs: [get-release-sha]
    uses: ./.github/workflows/00-ci.yml
    secrets: inherit

  deploy:
    name: Deploy to stg
    needs: [get-release-sha, quality-checks]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Setup Node.js environment
        uses: ./.github/actions/setup-node

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-dist-${{ needs.get-release-sha.outputs.sha }}

      - name: Extract build artifact
        run: |
          tar -xzf build-dist.tar.gz
          rm build-dist.tar.gz
          echo "[OK] Build artifacts extracted"
          ls -la build/

      - name: Deploy to stg
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: "./build/server"
          command: deploy --env stg

      - name: Deployment summary
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "[OK] Deployed to stg environment"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "[INFO] URL: https://stg.zenphry.com"
          echo "[INFO] Health checks skipped (Cloudflare firewall blocks GitHub IPs)"
          echo "[INFO] Manually verify deployment before promoting to production"
          echo ""
          echo "[INFO] To check deployment status:"
          echo "       npx wrangler deployments list --env stg"
          echo ""
          echo "[INFO] To rollback if needed:"
          echo "       npx wrangler rollback --env stg"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
